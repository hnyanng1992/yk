<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âá†‰ΩïÊï∞ÊçÆÂ±ïÁ§∫Â∑•ÂÖ∑</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body, #container {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 420px;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            z-index: 10;
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #3388FF, #4A90E2);
            color: white;
            padding: 18px 20px;
            border-radius: 12px 12px 0 0;
            margin: 0;
            position: sticky;
            top: 0;
            z-index: 11;
            flex-shrink: 0;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 20px;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .panel-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 500;
            color: #666;
        }
        
        .tab.active {
            border-bottom: 3px solid #3388FF;
            color: #3388FF;
            background-color: #f8fbff;
        }
        
        .current-tab-indicator {
            background: #e7f3ff;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 0;
            font-size: 14px;
            border-left: 4px solid #3388FF;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .current-tab-indicator::before {
            content: "üìç";
            font-size: 16px;
        }
        
        .action-buttons {
            background: white;
            padding: 0 0 12px 0;
            margin: 0;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .main-button-group {
            display: flex;
            gap: 10px;
            margin: 0;
        }
        
        .main-button-group button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3388FF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #297acc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(51, 136, 255, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            gap: 12px;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        .format-indicator {
            padding: 10px 14px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            border-left: 4px solid #28a745;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .format-indicator::before {
            content: "üìã";
        }
        
        .format-indicator.wkt {
            border-left-color: #3388FF;
        }
        
        .format-indicator.coords {
            border-left-color: #28a745;
        }
        
        .input-item {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .input-item textarea {
            width: 100%;
            flex: 1;
            min-height: 320px;
            margin: 0;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            box-sizing: border-box;
            line-height: 1.6;
            transition: border 0.3s;
        }
        
        .input-item textarea:focus {
            border-color: #3388FF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(51, 136, 255, 0.2);
        }
        
        .format-example {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
            flex-shrink: 0;
            padding: 0 4px;
        }
        
        .legend {
            padding: 14px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-title::before {
            content: "üé®";
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 4px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .legend-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .legend-line {
            background-color: #3388FF;
        }
        
        .legend-polygon {
            background-color: #FF6B6B;
        }
        
        .legend-point-color {
            background-color: #28a745;
        }
        
        .status-message {
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .intersection-panel {
            display: none;
            border: 1px solid #ffd3cf;
            background: #fff5f4;
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 8px;
            font-size: 12px;
        }

        .intersection-panel-title {
            color: #b42318;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .intersection-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 110px;
            overflow-y: auto;
        }

        .intersection-link {
            border: none;
            background: transparent;
            color: #0b63ce;
            text-align: left;
            cursor: pointer;
            padding: 0;
            font-size: 12px;
        }

        .intersection-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                width: calc(100% - 40px);
                max-height: 85vh;
            }
            .input-item textarea {
                min-height: 250px;
            }
            .panel-content {
                gap: 12px;
            }
            .main-button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div class="control-panel">
        <div class="panel-header">
            <h3>Âá†‰ΩïÊï∞ÊçÆÂ±ïÁ§∫Â∑•ÂÖ∑</h3>
        </div>
        
        <div class="panel-content">
            <!-- Ê†áÁ≠æÂØºËà™ -->
            <div class="tabs">
                <div class="tab" data-tab="points">ÁÇπÊï∞ÊçÆ</div>
                <div class="tab" data-tab="lines">Á∫øÊï∞ÊçÆ</div>
                <div class="tab active" data-tab="polygons">Â§öËæπÂΩ¢Êï∞ÊçÆ</div>
            </div>
            
            <!-- ÂΩìÂâçÈÄâ‰∏≠ÊåáÁ§∫Âô® -->
            <div class="current-tab-indicator" id="current-tab-indicator">
                ÂΩìÂâçÈÄâ‰∏≠: <strong>Â§öËæπÂΩ¢Êï∞ÊçÆ</strong>
            </div>
            
            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="action-buttons">
                <div class="main-button-group">
                    <button class="btn-success" id="show-current-btn">
                        <span>üîç</span> ÊòæÁ§∫ÂΩìÂâçÂõæÂΩ¢
                    </button>
                    <button class="btn-primary" id="show-all-btn">
                        <span>üó∫Ô∏è</span> ÊòæÁ§∫ÊâÄÊúâÂõæÂΩ¢
                    </button>
                    <button class="btn-secondary" id="clear-all-btn">
                        <span>üóëÔ∏è</span> Ê∏ÖÈô§ÊâÄÊúâ
                    </button>
                </div>
            </div>
            
            <!-- ÁÇπÊï∞ÊçÆÊ†áÁ≠æÈ°µ -->
            <div class="tab-content" id="points-tab">
                <div class="format-indicator" id="points-format-indicator">
                    Ê£ÄÊµãÂà∞Ê†ºÂºè: <strong>WKT</strong>
                </div>
                <div class="input-item">
                    <textarea id="points-input" placeholder="ËØ∑ËæìÂÖ•ÁÇπÊï∞ÊçÆ (WKTÊàñÂùêÊ†á‰∏≤)">POINT (104.065603 30.641998)</textarea>
                </div>
                <div class="format-example">
                    ÊèêÁ§∫: ÊîØÊåÅ POINT/MULTIPOINT ÊàñÂùêÊ†á‰∏≤Ê†ºÂºè
                </div>
            </div>
            
            <!-- Á∫øÊï∞ÊçÆÊ†áÁ≠æÈ°µ -->
            <div class="tab-content" id="lines-tab">
                <div class="format-indicator" id="lines-format-indicator">
                    Ê£ÄÊµãÂà∞Ê†ºÂºè: <strong>WKT</strong>
                </div>
                <div class="input-item">
                    <textarea id="lines-input" placeholder="ËØ∑ËæìÂÖ•Á∫øÊï∞ÊçÆ (WKTÊàñÂùêÊ†á‰∏≤)">MULTILINESTRING ((116.4279376 39.8443999,116.4278987 39.8444812,116.4278609 39.8445569))</textarea>
                </div>
                <div class="format-example">
                    ÊèêÁ§∫: ÊîØÊåÅ LINESTRING/MULTILINESTRING ÊàñÂùêÊ†á‰∏≤Ê†ºÂºè
                </div>
            </div>
            
            <!-- Â§öËæπÂΩ¢Êï∞ÊçÆÊ†áÁ≠æÈ°µ -->
            <div class="tab-content active" id="polygons-tab">
                <div class="format-indicator" id="polygon-format-indicator">
                    Ê£ÄÊµãÂà∞Ê†ºÂºè: <strong>WKT</strong>
                </div>
                <div class="input-item">
                    <textarea id="polygon-input" placeholder="ËØ∑ËæìÂÖ•Â§öËæπÂΩ¢Êï∞ÊçÆÔºåÊîØÊåÅ‰ª•‰∏ãÊ†ºÂºèÔºö
MULTIPOLYGON(((116.267 40.143, ...)), ((116.278 40.150, ...)))">MULTIPOLYGON (((116.267554 40.143674, 116.276690 40.146418, 116.279322 40.147106, 116.280005 40.144965, 116.283973 40.146092, 116.285033 40.146355, 116.289183 40.147556, 116.290073 40.146855, 116.290675 40.145969, 116.287825 40.144879, 116.288980 40.141879, 116.289029 40.141727, 116.292728 40.142273, 116.293094 40.142339, 116.295110 40.142508, 116.302110 40.143200, 116.302768 40.140103, 116.297349 40.139644, 116.297428 40.139241, 116.292626 40.138913, 116.290668 40.138374, 116.286600 40.138182, 116.283331 40.138137, 116.277863 40.137829, 116.277319 40.139720, 116.276325 40.139594, 116.275799 40.139680, 116.275014 40.140193, 116.274188 40.139238, 116.273272 40.138283, 116.271391 40.137550, 116.271312 40.137856, 116.271185 40.140226, 116.271226 40.141041, 116.269384 40.140577, 116.268609 40.142467, 116.268572 40.142557, 116.267884 40.142589, 116.267786 40.142671, 116.267554 40.143674)), ((116.278184 40.150960, 116.284874 40.152902, 116.285020 40.152947, 116.285938 40.151100, 116.279006 40.149139, 116.278184 40.150960)), ((116.241132 40.154537, 116.245402 40.155578, 116.246149 40.154617, 116.249661 40.155446, 116.250890 40.153510, 116.245508 40.152263, 116.245339 40.152220, 116.241132 40.154537)))</textarea>
                </div>
                <div class="format-example">
                    ÊèêÁ§∫: Â§öËæπÂΩ¢Êï∞ÊçÆÊîØÊåÅÂùêÊ†á‰∏≤ÂíåWKT(POLYGON/MULTIPOLYGON)Ê†ºÂºè
                </div>
            </div>
            
            <div class="status-message" id="status-message"></div>
            
            <div class="legend">
                <div class="legend-title">Âõæ‰æãËØ¥Êòé</div>
                <div class="legend-item">
                    <div class="legend-point legend-point-color"></div>
                    <span>ÁÇπÊï∞ÊçÆ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-line"></div>
                    <span>Á∫øÊï∞ÊçÆ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-polygon"></div>
                    <span>Â§öËæπÂΩ¢Êï∞ÊçÆ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color:#ff3b30;height:6px;"></div>
                    <span>Ëá™Áõ∏‰∫§È´ò‰∫Æ</span>
                </div>
            </div>

            <div class="intersection-panel" id="intersection-panel">
                <div class="intersection-panel-title" id="intersection-panel-title">‚ö†Ô∏è Ê£ÄÊµãÂà∞Â§öËæπÂΩ¢Ëá™Áõ∏‰∫§ÔºåÁÇπÂáªÂèØÂÆö‰ΩçÔºö</div>
                <ul class="intersection-list" id="intersection-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=1cf9fc45df860df45e87af1230f5da74"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÂú∞Âõæ
            var map = new AMap.Map('container', {
                zoom: 14,
                center: [116.276, 40.145], // Ë∞ÉÊï¥‰∏∫Ê≤ôÊ≤≥ÈôÑËøë
                viewMode: '3D'
            });
            
            var points = [], lines = [], polygons = [], polygonDiagnostics = [], intersectionAlerts = [], currentTab = 'polygons'; // merge-resolved: keep diagnostics state

            function normalizeInputText(text) {
                return (text || '')
                    .replace(/[Ôºå]/g, ',')
                    .replace(/[Ôºõ]/g, ';')
                    .replace(/[ÔΩú]/g, '|')
                    .replace(/\u3000/g, ' ');
            }

            // Ëá™Âä®Ê£ÄÊµãÊ†ºÂºè
            function detectFormat(input, type) {
                if (!input || input.trim() === '') return 'unknown';
                var normalized = normalizeInputText(input);
                var text = normalized.trim().toUpperCase();
                if (type === 'points') {
                    if (text.startsWith('MULTIPOINT') || text.startsWith('POINT')) return 'wkt';
                } else if (type === 'lines') {
                    if (text.startsWith('MULTILINESTRING') || text.startsWith('LINESTRING')) return 'wkt';
                } else if (type === 'polygons') {
                    if (text.startsWith('MULTIPOLYGON') || text.startsWith('POLYGON')) return 'wkt';
                }
                if (extractCoordinatePairs(normalized).length > 0) return 'coords';
                return 'unknown';
            }

            function extractCoordinatePairs(text) {
                var normalized = normalizeInputText(text);
                var matches = normalized.match(/-?\d+(?:\.\d+)?\s*[, ]\s*-?\d+(?:\.\d+)?/g) || [];
                return matches.map(m => {
                    var parts = m.trim().split(/[, ]+/);
                    return [parseFloat(parts[0]), parseFloat(parts[1])];
                }).filter(pair => !isNaN(pair[0]) && !isNaN(pair[1]));
            }

            function normalizePolygonRing(coords) {
                if (coords.length > 2) {
                    var first = coords[0], last = coords[coords.length - 1];
                    if (first[0] !== last[0] || first[1] !== last[1]) coords.push([first[0], first[1]]);
                }
                return coords;
            }

            function clearPolygonDiagnostics() {
                polygonDiagnostics.forEach(item => map.remove(item));
                polygonDiagnostics = [];
                intersectionAlerts = [];
                renderIntersectionAlerts([]);
            }

            function formatCoord(coord) {
                return `${coord[0].toFixed(6)}, ${coord[1].toFixed(6)}`;
            }

            function renderIntersectionAlerts(items) {
                var panel = document.getElementById('intersection-panel');
                var title = document.getElementById('intersection-panel-title');
                var list = document.getElementById('intersection-list');
                if (!panel || !list || !title) return;

                list.innerHTML = '';
                if (!items || items.length === 0) {
                    panel.style.display = 'none';
                    return;
                }

                title.textContent = `‚ö†Ô∏è Ê£ÄÊµãÂà∞ ${items.length} Â§ÑÂéüÂßãËøûÁ∫øËá™Áõ∏‰∫§ÔºåÁÇπÂáªÂèØÂÆö‰ΩçÂºÇÂ∏∏Á∫øÊÆµÔºö`;

                items.forEach((item, index) => {
                    var li = document.createElement('li');
                    var button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'intersection-link';
                    button.textContent = `Á¨¨ ${index + 1} Â§ÑÔºöÁ∫øÊÆµ[${item.segA + 1}] ${formatCoord(item.a1)} ‚Üí ${formatCoord(item.a2)} ‰∏é Á∫øÊÆµ[${item.segB + 1}] ${formatCoord(item.b1)} ‚Üí ${formatCoord(item.b2)}`;
                    button.addEventListener('click', function () {
                        var overlays = [];
                        if (item.marker) overlays.push(item.marker);
                        if (item.segAOverlay) overlays.push(item.segAOverlay);
                        if (item.segBOverlay) overlays.push(item.segBOverlay);
                        if (overlays.length > 0) {
                            map.setFitView(overlays);
                        } else {
                            map.setZoomAndCenter(Math.max(map.getZoom(), 17), item.point);
                        }

                        showStatus(`Â∑≤ÂÆö‰ΩçÂà∞Á¨¨ ${index + 1} Â§ÑËá™Áõ∏‰∫§ÔºàÂéüÂßãÁ∫øÊÆµÂºÇÂ∏∏Ôºâ`, true);

                        [item.segAOverlay, item.segBOverlay].forEach(function (seg) {
                            if (!seg) return;
                            seg.setOptions({ strokeWeight: 8, strokeColor: '#d92d20' });
                            setTimeout(function () {
                                seg.setOptions({ strokeWeight: 6, strokeColor: '#ff3b30' });
                            }, 700);
                        });

                        if (item.marker) {
                            item.marker.setOptions({ radius: 10, fillOpacity: 1 });
                            setTimeout(function () {
                                item.marker.setOptions({ radius: 7, fillOpacity: 0.9 });
                            }, 700);
                        }
                    });
                    li.appendChild(button);
                    list.appendChild(li);
                });

                panel.style.display = 'block';
            }

            function segmentIntersection(a, b, c, d) {
                var r = [b[0] - a[0], b[1] - a[1]];
                var s = [d[0] - c[0], d[1] - c[1]];
                var denominator = r[0] * s[1] - r[1] * s[0];
                if (Math.abs(denominator) < 1e-12) return null;

                var diff = [c[0] - a[0], c[1] - a[1]];
                var t = (diff[0] * s[1] - diff[1] * s[0]) / denominator;
                var u = (diff[0] * r[1] - diff[1] * r[0]) / denominator;

                if (t < 0 || t > 1 || u < 0 || u > 1) return null;
                return [a[0] + t * r[0], a[1] + t * r[1]];
            }

            function detectRingSelfIntersections(ring) {
                if (!ring || ring.length < 4) return [];
                var intersections = [];
                var seen = new Set();

                for (var i = 0; i < ring.length - 1; i++) {
                    var a1 = ring[i], a2 = ring[i + 1];
                    for (var j = i + 1; j < ring.length - 1; j++) {
                        if (Math.abs(i - j) <= 1) continue;
                        if (i === 0 && j === ring.length - 2) continue;

                        var b1 = ring[j], b2 = ring[j + 1];
                        var point = segmentIntersection(a1, a2, b1, b2);
                        if (!point) continue;

                        var key = point[0].toFixed(7) + ',' + point[1].toFixed(7) + ':' + i + '-' + j;
                        if (seen.has(key)) continue;
                        seen.add(key);
                        intersections.push({ point: point, segA: i, segB: j, a1: a1, a2: a2, b1: b1, b2: b2 });
                    }
                }
                return intersections;
            }

            function highlightSelfIntersections(path) {
                var rings = (path.length > 0 && Array.isArray(path[0][0])) ? path : [path];
                var segmentOverlays = {};
                var pointMarkers = {};
                var alerts = [];

                function getSegmentOverlay(ring, ringIndex, segIndex) {
                    var key = ringIndex + ':' + segIndex;
                    if (segmentOverlays[key]) return segmentOverlays[key];
                    var segLine = new AMap.Polyline({
                        path: [ring[segIndex], ring[segIndex + 1]],
                        strokeColor: '#ff3b30',
                        strokeWeight: 6,
                        strokeOpacity: 0.9,
                        lineJoin: 'round',
                        zIndex: 70
                    });
                    map.add(segLine);
                    polygonDiagnostics.push(segLine);
                    segmentOverlays[key] = segLine;
                    return segLine;
                }

                rings.forEach((ring, ringIndex) => {
                    var intersections = detectRingSelfIntersections(ring);

                    intersections.forEach(hit => {
                        var pointKey = hit.point[0].toFixed(7) + ',' + hit.point[1].toFixed(7);
                        var marker = pointMarkers[pointKey];
                        if (!marker) {
                            marker = new AMap.CircleMarker({
                                center: hit.point,
                                radius: 7,
                                strokeColor: '#ff3b30',
                                strokeWeight: 2,
                                strokeOpacity: 1,
                                fillColor: '#ffd6d3',
                                fillOpacity: 0.9,
                                zIndex: 80
                            });
                            map.add(marker);
                            polygonDiagnostics.push(marker);
                            pointMarkers[pointKey] = marker;
                        }

                        var segAOverlay = getSegmentOverlay(ring, ringIndex, hit.segA);
                        var segBOverlay = getSegmentOverlay(ring, ringIndex, hit.segB);

                        alerts.push({
                            point: hit.point,
                            marker: marker,
                            segA: hit.segA,
                            segB: hit.segB,
                            a1: hit.a1,
                            a2: hit.a2,
                            b1: hit.b1,
                            b2: hit.b2,
                            segAOverlay: segAOverlay,
                            segBOverlay: segBOverlay
                        });
                    });
                });

                return alerts;
            }

            function addPolygonWithDiagnostics(path) {
                var polygon = new AMap.Polygon({
                    path: path,
                    strokeColor: '#FF6B6B',
                    strokeWeight: 3,
                    strokeOpacity: 0.8,
                    fillColor: '#FF6B6B',
                    fillOpacity: 0.35
                });
                map.add(polygon);
                polygons.push(polygon);
                return highlightSelfIntersections(path);
            }
            
            function updateFormatIndicator(type) {
                var inputElement = document.getElementById(type === 'polygons' ? 'polygon-input' : type + '-input');
                var indicatorElement = document.getElementById(type === 'polygons' ? 'polygon-format-indicator' : type + '-format-indicator');
                
                if (inputElement && indicatorElement) {
                    var format = detectFormat(inputElement.value, type);
                    if (format === 'wkt') {
                        indicatorElement.innerHTML = 'Ê£ÄÊµãÂà∞Ê†ºÂºè: <strong>WKT</strong>';
                        indicatorElement.className = 'format-indicator wkt';
                    } else if (format === 'coords') {
                        indicatorElement.innerHTML = 'Ê£ÄÊµãÂà∞Ê†ºÂºè: <strong>ÂùêÊ†á‰∏≤</strong>';
                        indicatorElement.className = 'format-indicator coords';
                    } else {
                        indicatorElement.innerHTML = 'Ê†ºÂºè: <strong>Êú™Áü•</strong>';
                        indicatorElement.className = 'format-indicator';
                    }
                }
            }
            
            function showStatus(message, isSuccess) {
                var statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
                statusElement.style.display = 'block';
                setTimeout(function() { statusElement.style.display = 'none'; }, 5000);
            }
            
            // Ê†áÁ≠æÂàáÊç¢ÈÄªËæë
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId + '-tab').classList.add('active');
                    currentTab = tabId;
                    updateCurrentTabIndicator();
                });
            });

            ['points', 'lines', 'polygon'].forEach(type => {
                document.getElementById(type + '-input').addEventListener('input', function() {
                    updateFormatIndicator(type === 'polygon' ? 'polygons' : type);
                });
            });

            function updateCurrentTabIndicator() {
                const tabNames = { 'points': 'ÁÇπÊï∞ÊçÆ', 'lines': 'Á∫øÊï∞ÊçÆ', 'polygons': 'Â§öËæπÂΩ¢Êï∞ÊçÆ' };
                document.getElementById('current-tab-indicator').innerHTML = `ÂΩìÂâçÈÄâ‰∏≠: <strong>${tabNames[currentTab]}</strong>`;
            }

            function showCurrent() { 
                if (currentTab === 'points') showPoints(); 
                else if (currentTab === 'lines') showLines(); 
                else if (currentTab === 'polygons') showPolygons(); 
            }

            function showAll() { 
                showPoints(); 
                showLines(); 
                showPolygons(); 
            }

            // ÁÇπÊï∞ÊçÆÂ±ïÁ§∫ÔºàÊîØÊåÅ WKT/ÂùêÊ†á‰∏≤Ôºâ
            function showPoints() {
                points.forEach(point => map.remove(point)); points = [];
                var input = document.getElementById('points-input').value.trim();
                if (!input) return;
                try {
                    extractCoordinatePairs(input).forEach(coord => {
                        var point = new AMap.Marker({
                            position: coord,
                            icon: new AMap.Icon({
                                size: new AMap.Size(8, 8),
                                image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOCIgIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDggOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI0IiBjeT0iNCIgcj0iNCIgZmlsbD0iIzI4YTc0NSIvPjwvc3ZnPg==',
                                anchor: 'center'
                            })
                        });
                        map.add(point);
                        points.push(point);
                    });

                    if (points.length > 0) {
                        map.setFitView(points);
                        showStatus(`ÊàêÂäüÊ∑ªÂä† ${points.length} ‰∏™ÁÇπ`, true);
                    } else {
                        showStatus('Êú™ËÉΩËß£ÊûêÁÇπÊï∞ÊçÆ', false);
                    }
                } catch (e) { showStatus('Ëß£ÊûêÁÇπÊï∞ÊçÆÂá∫Èîô', false); }
            }

            // Á∫øÊï∞ÊçÆÂ±ïÁ§∫ÔºàÊîØÊåÅ WKT/ÂùêÊ†á‰∏≤Ôºâ
            function showLines() {
                lines.forEach(line => map.remove(line)); lines = [];
                var input = document.getElementById('lines-input').value.trim();
                if (!input) return;
                
                try {
                    var format = detectFormat(input, 'lines');

                    if (format === 'wkt') {
                        var parts = input.match(/\([^()]+\)/g) || [];
                        parts.forEach(part => {
                            var coords = extractCoordinatePairs(part);
                            if (coords.length > 1) {
                                var line = new AMap.Polyline({ path: coords, strokeColor: '#3388FF', strokeWeight: 4 });
                                map.add(line);
                                lines.push(line);
                            }
                        });
                    } else {
                        var lineTexts = normalizeInputText(input).split(/\n+|;/).map(t => t.trim()).filter(Boolean);
                        if (lineTexts.length <= 1) lineTexts = [input];
                        lineTexts.forEach(text => {
                            var coords = extractCoordinatePairs(text);
                            if (coords.length > 1) {
                                var line = new AMap.Polyline({ path: coords, strokeColor: '#3388FF', strokeWeight: 4 });
                                map.add(line);
                                lines.push(line);
                            }
                        });
                    }

                    if (lines.length > 0) {
                        map.setFitView(lines);
                        showStatus(`ÊàêÂäüÊ∑ªÂä† ${lines.length} Êù°Á∫ø`, true);
                    } else {
                        showStatus('Êú™ËÉΩËß£ÊûêÁ∫øÊï∞ÊçÆ', false);
                    }
                } catch (e) { showStatus('Ëß£ÊûêÁ∫øÊï∞ÊçÆÂá∫Èîô', false); }
            }

            // Â§öËæπÂΩ¢Êï∞ÊçÆÂ±ïÁ§∫ÔºàÊîØÊåÅ WKT/ÂùêÊ†á‰∏≤Ôºâ
            function showPolygons() {
                polygons.forEach(p => map.remove(p)); polygons = [];
                clearPolygonDiagnostics();
                var input = document.getElementById('polygon-input').value.trim();
                if (!input) { showStatus('ËæìÂÖ•‰∏∫Á©∫', false); return; }

                // È¢ÑÂ§ÑÁêÜÊñáÊú¨ÔºöÂéªÈô§Êç¢Ë°åÔºåÊ†áÂáÜÂåñÁ©∫Ê†º
                var cleanInput = input.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').toUpperCase();
                var count = 0;
                var intersectionCount = 0;
                var intersections = [];

                try {
                    // Ëß£ÊûêÂùêÊ†áÂØπÁöÑËæÖÂä©ÂáΩÊï∞ "x y, x y" -> [[x,y], [x,y]]
                    function parseRing(str) { return normalizePolygonRing(extractCoordinatePairs(str)); }

                    if (cleanInput.includes('MULTIPOLYGON')) {
                        // ÊèêÂèñÊúÄÂ§ñÂ±ÇÊã¨Âè∑ÂÜÖÂÆπ
                        var inner = cleanInput.substring(cleanInput.indexOf('((') + 1, cleanInput.lastIndexOf('))') + 2); // Á≤óÁï•ÊèêÂèñ
                        // ‰ΩøÁî®Ê≠£ÂàôÂåπÈÖç ((...)) ÁªìÊûÑÔºåËß£ÂÜ≥ split Êó†Ê≥ïÂ§ÑÁêÜÁ©∫Ê†ºÁöÑÈóÆÈ¢ò
                        // Ê≠£ÂàôÂê´‰πâÔºöÂåπÈÖç (( ÂºÄÂ§¥Ôºå‰∏≠Èó¥ÊòØÈùû ( ÁöÑÂ≠óÁ¨¶Ôºå‰ª• )) ÁªìÂ∞æÔºàÂ§ÑÁêÜÂçï‰∏™‰∏çÂê´Ê¥ûÁöÑÂ§öËæπÂΩ¢Ôºâ
                        // Â¶ÇÊûúÊúâÊ¥ûÔºàÂ¶Ç ((..), (..))ÔºâÔºåÊ≠§Ê≠£ÂàôÈúÄÊõ¥Â§çÊùÇÔºå‰ΩÜÈíàÂØπ‰Ω†ÁöÑÊï∞ÊçÆÔºå‰ª•‰∏ãÈÄªËæëË∂≥Â§üÔºö
                        
                        // ‰øÆÂ§çÈÄªËæëÔºö‰ΩøÁî®Ê≠£Âàô \)\s*,\s*\( ‰Ωú‰∏∫ÂàÜÈöîÁ¨¶ÈÄªËæëÔºåÊàñËÄÖÁõ¥Êé•ÊäìÂèñÂùó
                        // ÈíàÂØπ MULTIPOLYGON (((A)), ((B))) Ê†ºÂºè
                        var subPolys = inner.match(/\(\([^\(]+\)\)/g);

                        if (subPolys) {
                            subPolys.forEach(polyStr => {
                                // ÊØè‰∏™ polyStr ÂΩ¢Â¶Ç ((x y, x y...))
                                // AMap ÊîØÊåÅÁõ¥Êé•‰º†‰∫åÁª¥Êï∞ÁªÑ‰Ωú‰∏∫ path
                                var ringStr = polyStr.match(/\([^)]+\)/g); // ÊèêÂèñÁéØ
                                if (ringStr) {
                                    var path = [];
                                    ringStr.forEach(r => path.push(parseRing(r)));
                                    
                                    intersections = intersections.concat(addPolygonWithDiagnostics(path));
                                    count++;
                                }
                            });
                        }
                    } else if (cleanInput.includes('POLYGON')) {
                        // Â§ÑÁêÜÂçï‰∏™ POLYGON
                        var ringStr = cleanInput.match(/\([^)]+\)/g);
                        if (ringStr) {
                            var path = [];
                            ringStr.forEach(r => path.push(parseRing(r)));
                            intersections = intersections.concat(addPolygonWithDiagnostics(path));
                            count++;
                        }
                    } else {
                        // ÂùêÊ†á‰∏≤Ê†ºÂºèÔºö
                        // 1) Âçï‰∏™Èù¢Ôºöx,y;x,y;...ÔºàÊîØÊåÅ‰Ω†Êèê‰æõÁöÑÈïøÂùêÊ†á‰∏≤Ôºâ
                        // 2) Â§ö‰∏™Èù¢ÔºöÁî®Êç¢Ë°åÂàÜÈöî‰∏çÂêåÈù¢
                        // 3) Ê¥ûÔºöÂêå‰∏ÄÈù¢ÂÜÖÁî® | ÂàÜÈöîÂ§ñÁéØ‰∏éÂÜÖÁéØ
                        var normalized = normalizeInputText(input);
                        var polygonTexts = normalized.split(/\n+/).map(t => t.trim()).filter(Boolean);
                        if (polygonTexts.length === 0) polygonTexts = [normalized];

                        polygonTexts.forEach(polyText => {
                            var ringTexts = polyText.split('|').map(t => t.trim()).filter(Boolean);
                            var path = ringTexts.map(parseRing).filter(ring => ring.length > 3);
                            if (path.length > 0) {
                                intersections = intersections.concat(addPolygonWithDiagnostics(path.length === 1 ? path[0] : path));
                                count++;
                            }
                        });
                    }

                    if (count > 0) {
                        var message = `ÊàêÂäüÁªòÂà∂ ${count} ‰∏™Âú∞Âùó`;
                        intersectionCount = intersections.length;
                        if (intersectionCount > 0) message += `ÔºåÊ£ÄÊµãÂà∞ ${intersectionCount} Â§ÑËá™Áõ∏‰∫§`;
                        else message += 'ÔºåÊú™Ê£ÄÊµãÂà∞Ëá™Áõ∏‰∫§';
                        showStatus(message, true);
                        renderIntersectionAlerts(intersections);
                        intersectionAlerts = intersections;
                        map.setFitView(polygons.concat(polygonDiagnostics));
                    } else {
                        showStatus('Êú™ËÉΩËß£ÊûêÂ§öËæπÂΩ¢Êï∞ÊçÆ', false);
                    }
                } catch (e) {
                    console.error(e);
                    showStatus('Ëß£ÊûêÈîôËØØ: ' + e.message, false);
                }
            }

            function clearAll() {
                points.forEach(p => map.remove(p)); points = [];
                lines.forEach(l => map.remove(l)); lines = [];
                polygons.forEach(p => map.remove(p)); polygons = [];
                clearPolygonDiagnostics(); // merge-resolved: clear diagnostics overlays and alerts together
                showStatus('Â∑≤Ê∏ÖÈô§ÊâÄÊúâÂõæÂΩ¢', true);
            }

            document.getElementById('show-current-btn').addEventListener('click', showCurrent);
            document.getElementById('show-all-btn').addEventListener('click', showAll);
            document.getElementById('clear-all-btn').addEventListener('click', clearAll);

            setTimeout(function() { 
                updateCurrentTabIndicator();
                updateFormatIndicator('points');
                updateFormatIndicator('lines');
                updateFormatIndicator('polygons');
                showAll();
            }, 500);
        });
    </script>
</body>
</html>
